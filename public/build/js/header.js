document.addEventListener("DOMContentLoaded",async function(){console.log("âœ… header.js: DOMContentLoaded");const e=document.querySelector(".apps-header");if(!e)return void console.warn("header.js: no se encontrÃ³ .apps-header, saliendo.");const t=document.getElementById("allied-companies-link"),s=document.getElementById("allied-companies-dropdown"),n=document.getElementById("search-icon"),a=document.getElementById("close-search-btn"),i=document.getElementById("search-input"),o=document.getElementById("mobile-menu-btn"),c=document.getElementById("header-menu"),l=document.getElementById("profile-menu-toggle"),r=document.getElementById("profile-menu"),d=e.querySelector(".apps-header__search-container");let p=[];o&&c&&o.addEventListener("click",function(){c.classList.toggle("show"),c.classList.contains("show")&&(s.classList.remove("show"),r.classList.remove("show"))});const u=document.createElement("div");if(u.id="search-suggestions",u.classList.add("search-suggestions"),d&&d.appendChild(u),t&&s&&t.addEventListener("click",function(e){if(console.log("ðŸŸ¥ Click en Empresas Aliadas"),e.preventDefault(),e.stopPropagation(),window.innerWidth<=790){if(c&&!c.contains(s)){const e=c.querySelector(".apps-header__nav");e&&e.appendChild(s)}s.style.position="static",s.style.width="100%",s.style.maxWidth="none"}else{const e=t.getBoundingClientRect();s.style.position="absolute",s.style.left=`${e.left}px`,s.style.top="50px",s.style.width="auto"}s.classList.toggle("show"),r.classList.remove("show")}),n&&a&&i&&d){n.addEventListener("click",function(t){t.stopPropagation(),window.innerWidth<=790&&c&&!c.classList.contains("show")&&c.classList.add("show"),e.classList.add("search-active"),i.focus()}),a.addEventListener("click",function(){e.classList.remove("search-active"),i.value="",i.dispatchEvent(new Event("input",{bubbles:!0})),u.style.display="none"}),p=await async function(){try{const e=await fetch("/api/apps");if(!e.ok)return[];return(await e.json()).flatMap(e=>(e.applications||[]).map(t=>({...t,company_id:e.company_id,company_name:e.company_name})))}catch(e){return console.error("Error al obtener las apps para la bÃºsqueda:",e),[]}}(),i.addEventListener("input",function(){const e=this.value.toLowerCase().trim();if(""===e)return void(u.style.display="none");!function(e){if(!e.length||!u)return void(u.style.display="none");u.innerHTML=e.slice(0,5).map(e=>{const t=(s=e.company_name)&&s.toLowerCase().replace(/\s/g,"_").replace(/[^a-z0-9_-]/g,"")||"undefined";var s;const n=e.image?`/build/img/apps/${t}/${e.image}`:`https://placehold.co/40x40/2c3e50/ffffff?text=${encodeURIComponent((e.app_name||"").charAt(0)||"A")}`;return`\n                <a href="/app_detail?id=${e.app_id}" class="suggestion-item">\n                    <img src="${n}" class="suggestion-icon" alt="${e.app_name}">\n                    <span class="suggestion-name">${e.app_name}</span>\n                </a>\n            `}).join(""),u.style.display="block"}(p.filter(t=>(t.app_name||"").toLowerCase().trim().includes(e)))})}l&&r&&l.addEventListener("click",function(e){console.log("ðŸŸ¦ Click en avatar de usuario"),e.stopPropagation(),r.classList.toggle("show");const t=r.classList.contains("show");if(l.setAttribute("aria-expanded",t?"true":"false"),r.setAttribute("aria-hidden",t?"false":"true"),t){const e=l.getBoundingClientRect();window.innerWidth<=790?(r.style.position="fixed",r.style.top=`${e.bottom+8}px`,r.style.left=`${e.left}px`,r.style.right="auto"):(r.style.position="absolute",r.style.top="56px",r.style.right="2rem",r.style.left="auto")}s.classList.remove("show")}),document.addEventListener("click",function(a){if(s&&s.classList.contains("show")&&(t.contains(a.target)||s.contains(a.target)||s.classList.remove("show")),r&&r.classList.contains("show")&&(l.contains(a.target)||r.contains(a.target)||(r.classList.remove("show"),l.setAttribute("aria-expanded","false"),r.setAttribute("aria-hidden","true"))),e&&e.classList.contains("search-active")&&d&&n){d.contains(a.target)||n.contains(a.target)||(e.classList.remove("search-active"),u.style.display="none")}}),async function(){if(s)try{const e=await fetch("/api/empresas/listar");if(!e.ok)return void(s.innerHTML='<p class="no-results">No se pudieron cargar las empresas aliadas.</p>');const t=(await e.json()).filter(e=>1!==Number(e.id));if(!t.length)return void(s.innerHTML='<p class="no-results">No hay empresas aliadas.</p>');s.innerHTML=`\n                <ul>\n                    ${t.map(e=>`\n                        <li>\n                            <a href="/?company_id=${e.id}">\n                                ${e.name}\n                            </a>\n                        </li>\n                    `).join("")}\n                </ul>\n            `}catch(e){console.error("Error al cargar empresas aliadas:",e),s.innerHTML='<p class="no-results">Error al cargar empresas aliadas.</p>'}}()});