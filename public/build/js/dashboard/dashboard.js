Chart.register(ChartDataLabels);let chartInstanceDia=null,chartInstanceTop=null,chartInstanceEmp=null,chartInstanceMes=null,chartInstanceCat=null,showLabels=!1;const PALETA_COLORES=["#198754","#0d6efd","#dc3545","#ffc107","#6f42c1","#0dcaf0","#fd7e14","#20c997"];async function cargarFiltroEmpresas(){try{const e=await fetch("/api/empresas/listar"),a=await e.json(),t=document.getElementById("companyFilter");t&&a.length>0&&a.forEach(e=>{const a=document.createElement("option");a.value=e.id,a.textContent=e.name,t.appendChild(a)})}catch(e){}}async function cargarDashboard(){const e=document.getElementById("companyFilter")?document.getElementById("companyFilter").value:"",a=document.getElementById("limitFilter").value,t=document.getElementById("dateStart").value,n=document.getElementById("dateEnd").value,o=document.querySelector(".table-responsive");o&&("all"===a||parseInt(a)>20?o.classList.add("expanded"):o.classList.remove("expanded"));let s=`/api/dashboard?limit=${a}`;e&&(s+=`&company_id=${e}`),t&&(s+=`&date_start=${t}`),n&&(s+=`&date_end=${n}`);try{const e=await fetch(s),a=await e.json();if("success"===a.status){const e=document.getElementById("filterContainer");e&&3==a.role_detected&&(e.style.display="block"),renderizarDashboard(a.data,a.view_mode),renderizarTabla(a.data.latest_transactions)}}catch(e){console.error("Error:",e)}}document.addEventListener("DOMContentLoaded",async()=>{if(!document.querySelector(".dashboard__grid"))return;await cargarFiltroEmpresas(),cargarDashboard(),document.getElementById("companyFilter")?.addEventListener("change",()=>cargarDashboard()),document.getElementById("toggleLabels")?.addEventListener("change",e=>{showLabels=e.target.checked,cargarDashboard()}),document.getElementById("btnFilterTable")?.addEventListener("click",()=>cargarDashboard());const e=document.getElementById("dateStart"),a=document.getElementById("dateEnd"),t=document.getElementById("limitFilter"),n=()=>{t.value="all"};e?.addEventListener("change",n),a?.addEventListener("change",n),t?.addEventListener("change",()=>{e.value="",a.value=""})});const formatMoney=e=>new Intl.NumberFormat("es-CO",{style:"currency",currency:"COP",minimumFractionDigits:0}).format(e),obtenerMapaColores=e=>{let a={};return e.forEach((e,t)=>{a[e]=PALETA_COLORES[t%PALETA_COLORES.length]}),a};function renderizarDashboard(e,a){document.getElementById("kpi-users")&&(document.getElementById("kpi-users").textContent=e.kpis.total_users),document.getElementById("kpi-apps")&&(document.getElementById("kpi-apps").textContent=e.kpis.total_apps),document.getElementById("kpi-revenue")&&(document.getElementById("kpi-revenue").textContent=formatMoney(e.kpis.total_revenue_historic)),chartInstanceDia&&chartInstanceDia.destroy(),chartInstanceTop&&chartInstanceTop.destroy(),chartInstanceEmp&&chartInstanceEmp.destroy(),chartInstanceMes&&chartInstanceMes.destroy(),chartInstanceCat&&chartInstanceCat.destroy();let t=[];e.sales_by_company&&(t=e.sales_by_company.map(e=>e.company_name));const n=obtenerMapaColores(t),o=document.getElementById("chartVentasDia");if(o){const t=e.sales_daily.map(e=>e.report_date),s=[];if(s.push({label:"Total General",data:e.sales_daily.map(e=>e.total_revenue),borderColor:"#adb5bd",backgroundColor:"rgba(173, 181, 189, 0.1)",fill:!0,tension:.4,order:99,datalabels:{display:showLabels,align:"top",anchor:"end",color:"#666",font:{weight:"bold"},formatter:e=>e>0?formatMoney(e):""}}),e.sales_daily_breakdown&&"global"===a){const a={};e.sales_daily_breakdown.forEach(e=>{a[e.company_name]||(a[e.company_name]={}),a[e.company_name][e.report_date]=parseFloat(e.total_revenue)}),Object.keys(a).forEach((e,o)=>{const r=t.map(t=>a[e][t]||0),l=n[e]||"#333",d=4+16*o;s.push({label:e,data:r,borderColor:l,backgroundColor:l,borderWidth:2,tension:.3,order:1,datalabels:{display:showLabels,align:"start",anchor:"start",offset:d,color:l,font:{weight:"bold",size:10},backgroundColor:"rgba(255, 255, 255, 0.9)",borderRadius:3,padding:1,formatter:e=>e>0?formatMoney(e):""}})})}chartInstanceDia=new Chart(o,{type:"line",data:{labels:t,datasets:s},options:{layout:{padding:{top:20}},responsive:!0,plugins:{legend:{position:"top"},tooltip:{mode:"index",intersect:!1}},scales:{y:{grace:"10%",ticks:{callback:function(e){return"$"+e}}}}}})}const s=document.getElementById("chartTopApps");if(s){const a=e.top_apps.map(e=>{const a=parseFloat(e.price)>0?formatMoney(e.price):"(Gratis)";return`${e.app_name} ${a}`});chartInstanceTop=new Chart(s,{type:"bar",data:{labels:a,datasets:[{label:"Ventas",data:e.top_apps.map(e=>e.total_sold),backgroundColor:PALETA_COLORES.slice(0,5),borderRadius:4,datalabels:{display:showLabels,color:"#fff",anchor:"center"}}]},options:{plugins:{legend:{display:!1}},scales:{y:{ticks:{stepSize:1}}}}})}const r=document.getElementById("containerEmpresas"),l=document.getElementById("chartEmpresas");if(r&&l)if("global"===a&&e.sales_by_company){r.style.display="block";const a=e.sales_by_company.map(e=>e.company_name);chartInstanceEmp=new Chart(l,{type:"bar",data:{labels:a,datasets:[{label:"Ingresos",data:e.sales_by_company.map(e=>e.total_revenue),backgroundColor:a.map(e=>n[e]||"#ccc"),borderRadius:4,datalabels:{display:showLabels,anchor:"end",align:"right",formatter:e=>formatMoney(e)}}]},options:{layout:{padding:{right:30}},indexAxis:"y",responsive:!0,plugins:{legend:{display:!1}},scales:{x:{grace:"10%",ticks:{callback:e=>"$"+e}}}}})}else r.style.display="none";const d=document.getElementById("chartMensual");if(d){let t=[];if(e.sales_monthly_breakdown&&"global"===a)t=[...new Set(e.sales_monthly_breakdown.map(e=>e.periodo))].sort();else{const a=e.sales_monthly.slice().reverse();t=a.map(e=>e.periodo)}const o=[];if(e.sales_monthly_breakdown&&"global"===a){const a={};t.forEach(e=>a[e]=0),e.sales_monthly_breakdown.forEach(e=>{a[e.periodo]+=parseFloat(e.total_revenue)}),o.push({type:"line",label:"Total General",data:t.map(e=>a[e]),borderColor:"#333",borderWidth:2,pointBackgroundColor:"#333",fill:!1,tension:.1,order:0,datalabels:{display:showLabels,align:"top",anchor:"end",color:"#333",font:{weight:"bold"},formatter:e=>formatMoney(e)}});const s={};e.sales_monthly_breakdown.forEach(e=>{s[e.company_name]||(s[e.company_name]={}),s[e.company_name][e.periodo]=parseFloat(e.total_revenue)}),Object.keys(s).forEach(e=>{const a=t.map(a=>s[e][a]||0),r=n[e]||"#ccc";o.push({type:"bar",label:e,data:a,backgroundColor:r,stack:"Stack 0",order:1,datalabels:{display:showLabels,color:"white",formatter:e=>e>0?formatMoney(e):""}})})}else{const a=e.sales_monthly.slice().reverse();t=a.map(e=>e.periodo),o.push({type:"bar",label:"Ingresos",data:a.map(e=>e.total_revenue),backgroundColor:"#fd7e14",datalabels:{display:showLabels,anchor:"end",align:"top",formatter:e=>formatMoney(e)}})}chartInstanceMes=new Chart(d,{data:{labels:t,datasets:o},options:{responsive:!0,plugins:{legend:{display:"global"===a}},scales:{x:{stacked:!0},y:{stacked:!0,beginAtZero:!0,ticks:{callback:e=>"$"+e}}}}})}const c=document.getElementById("chartCategorias");c&&e.sales_category&&(chartInstanceCat=new Chart(c,{type:"doughnut",data:{labels:e.sales_category.map(e=>e.category_name),datasets:[{data:e.sales_category.map(e=>e.total_revenue),backgroundColor:PALETA_COLORES,datalabels:{display:showLabels,color:"white",formatter:(e,a)=>{let t=0;return a.chart.data.datasets[0].data.map(e=>t+=Number(e)),(100*e/t).toFixed(0)+"%"}}}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right"}}}}))}function renderizarTabla(e){const a=document.getElementById("tableBodyTransactions");a&&(a.innerHTML="",e&&0!==e.length?e.forEach(e=>{const t=document.createElement("tr"),n=new Date(e.created_at).toLocaleDateString("es-CO",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}),o=e.company_name||"-";t.innerHTML=`<td>#${e.id}</td><td>${e.user_email}</td><td style="font-weight:500">${e.app_name}</td><td>${o}</td><td>${n}</td><td class="amount-col">${formatMoney(e.amount)}</td><td><span class="status-badge">Completado</span></td>`,a.appendChild(t)}):a.innerHTML='<tr><td colspan="7" style="text-align:center; padding: 2rem;">No hay datos para mostrar con estos filtros</td></tr>')}